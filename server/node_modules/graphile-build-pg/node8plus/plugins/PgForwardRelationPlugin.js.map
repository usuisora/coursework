{"version":3,"sources":["../../src/plugins/PgForwardRelationPlugin.js"],"names":["debug","PgForwardRelationPlugin","builder","hook","fields","build","context","extend","getSafeAliasFromResolveInfo","getSafeAliasFromAlias","pgGetGqlTypeByTypeIdAndModifier","pgIntrospectionResultsByKind","introspectionResultsByKind","pgSql","sql","inflection","pgQueryFromResolveData","queryFromResolveData","pgOmit","omit","sqlCommentByAddingTags","describePgEntity","scope","isPgRowType","isMutationPayload","pgIntrospection","pgIntrospectionTable","fieldWithHooks","Self","table","kind","namespace","foreignKeyConstraints","constraints","filter","con","type","reduce","memo","constraint","gqlTableType","id","tableTypeName","name","classId","foreignTable","classById","foreignClassId","gqlForeignTableType","foreignTableTypeName","Error","foreignSchema","keys","keyAttributes","foreignKeys","foreignKeyAttributes","every","_","some","key","fieldName","singleRelationByKeys","getDataFromParsedResolveInfoFragment","addDataGenerator","parsedResolveInfoFragment","pgQuery","queryBuilder","select","resolveData","foreignTableAlias","identifier","Symbol","query","asJson","innerQueryBuilder","parentQueryBuilder","forEach","i","where","fragment","getTableAlias","alias","description","tags","forwardDescription","resolve","rawData","_args","_context","resolveInfo","data","safeAlias","pgFieldIntrospection","isPgForwardRelationField"],"mappings":"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","file":"PgForwardRelationPlugin.js","sourcesContent":["// @flow\nimport type { Plugin } from \"graphile-build\";\nimport debugFactory from \"debug\";\n\nconst debug = debugFactory(\"graphile-build-pg\");\n\nexport default (function PgForwardRelationPlugin(builder) {\n  builder.hook(\"GraphQLObjectType:fields\", (fields, build, context) => {\n    const {\n      extend,\n      getSafeAliasFromResolveInfo,\n      getSafeAliasFromAlias,\n      pgGetGqlTypeByTypeIdAndModifier,\n      pgIntrospectionResultsByKind: introspectionResultsByKind,\n      pgSql: sql,\n      inflection,\n      pgQueryFromResolveData: queryFromResolveData,\n      pgOmit: omit,\n      sqlCommentByAddingTags,\n      describePgEntity,\n    } = build;\n    const {\n      scope: {\n        isPgRowType,\n        isMutationPayload,\n        pgIntrospection,\n        pgIntrospectionTable,\n      },\n      fieldWithHooks,\n      Self,\n    } = context;\n\n    const table = pgIntrospectionTable || pgIntrospection;\n    if (\n      !(isPgRowType || isMutationPayload) ||\n      !table ||\n      table.kind !== \"class\" ||\n      !table.namespace\n    ) {\n      return fields;\n    }\n    // This is a relation in which we (table) are local, and there's a foreign table\n\n    const foreignKeyConstraints = table.constraints.filter(\n      con => con.type === \"f\"\n    );\n\n    return extend(\n      fields,\n      foreignKeyConstraints.reduce((memo, constraint) => {\n        if (omit(constraint, \"read\")) {\n          return memo;\n        }\n        const gqlTableType = pgGetGqlTypeByTypeIdAndModifier(\n          table.type.id,\n          null\n        );\n        const tableTypeName = gqlTableType.name;\n        if (!gqlTableType) {\n          debug(\n            `Could not determine type for table with id ${constraint.classId}`\n          );\n          return memo;\n        }\n        const foreignTable =\n          introspectionResultsByKind.classById[constraint.foreignClassId];\n        const gqlForeignTableType = pgGetGqlTypeByTypeIdAndModifier(\n          foreignTable.type.id,\n          null\n        );\n        const foreignTableTypeName = gqlForeignTableType.name;\n        if (!gqlForeignTableType) {\n          debug(\n            `Could not determine type for foreign table with id ${\n              constraint.foreignClassId\n            }`\n          );\n          return memo;\n        }\n        if (!foreignTable) {\n          throw new Error(\n            `Could not find the foreign table (constraint: ${constraint.name})`\n          );\n        }\n        if (omit(foreignTable, \"read\")) {\n          return memo;\n        }\n        const foreignSchema = foreignTable.namespace;\n\n        const keys = constraint.keyAttributes;\n        const foreignKeys = constraint.foreignKeyAttributes;\n        if (!keys.every(_ => _) || !foreignKeys.every(_ => _)) {\n          throw new Error(\"Could not find key columns!\");\n        }\n        if (keys.some(key => omit(key, \"read\"))) {\n          return memo;\n        }\n        if (foreignKeys.some(key => omit(key, \"read\"))) {\n          return memo;\n        }\n\n        const fieldName = inflection.singleRelationByKeys(\n          keys,\n          foreignTable,\n          table,\n          constraint\n        );\n\n        memo = extend(\n          memo,\n          {\n            [fieldName]: fieldWithHooks(\n              fieldName,\n              ({ getDataFromParsedResolveInfoFragment, addDataGenerator }) => {\n                addDataGenerator(parsedResolveInfoFragment => {\n                  return {\n                    pgQuery: queryBuilder => {\n                      queryBuilder.select(() => {\n                        const resolveData = getDataFromParsedResolveInfoFragment(\n                          parsedResolveInfoFragment,\n                          gqlForeignTableType\n                        );\n                        const foreignTableAlias = sql.identifier(Symbol());\n                        const query = queryFromResolveData(\n                          sql.identifier(foreignSchema.name, foreignTable.name),\n                          foreignTableAlias,\n                          resolveData,\n                          { asJson: true },\n                          innerQueryBuilder => {\n                            innerQueryBuilder.parentQueryBuilder = queryBuilder;\n                            keys.forEach((key, i) => {\n                              innerQueryBuilder.where(\n                                sql.fragment`${queryBuilder.getTableAlias()}.${sql.identifier(\n                                  key.name\n                                )} = ${foreignTableAlias}.${sql.identifier(\n                                  foreignKeys[i].name\n                                )}`\n                              );\n                            });\n                          }\n                        );\n                        return sql.fragment`(${query})`;\n                      }, getSafeAliasFromAlias(parsedResolveInfoFragment.alias));\n                    },\n                  };\n                });\n                return {\n                  description:\n                    constraint.tags.forwardDescription ||\n                    `Reads a single \\`${foreignTableTypeName}\\` that is related to this \\`${tableTypeName}\\`.`,\n                  type: gqlForeignTableType, // Nullable since RLS may forbid fetching\n                  resolve: (rawData, _args, _context, resolveInfo) => {\n                    const data = isMutationPayload ? rawData.data : rawData;\n                    const safeAlias = getSafeAliasFromResolveInfo(resolveInfo);\n                    return data[safeAlias];\n                  },\n                };\n              },\n              {\n                pgFieldIntrospection: constraint,\n                isPgForwardRelationField: true,\n              }\n            ),\n          },\n          `Forward relation for ${describePgEntity(\n            constraint\n          )}. To rename this relation with smart comments:\\n\\n  ${sqlCommentByAddingTags(\n            constraint,\n            {\n              fieldName: \"newNameHere\",\n            }\n          )}`\n        );\n        return memo;\n      }, {}),\n      `Adding forward relations to '${Self.name}'`\n    );\n  });\n}: Plugin);\n"]}