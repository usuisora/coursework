{"version":3,"sources":["../../src/plugins/PgConnectionArgOrderBy.js"],"names":["PgConnectionArgOrderBy","builder","orderByNullsLast","hook","_","build","newWithHooks","pgIntrospectionResultsByKind","introspectionResultsByKind","graphql","GraphQLEnumType","inflection","pgOmit","omit","sqlCommentByAddingTags","describePgEntity","class","forEach","table","isSelectable","namespace","tableTypeName","tableType","name","orderByType","description","values","NATURAL","value","alias","specs","__origin","pgIntrospection","isPgRowSortEnum","args","context","extend","getTypeByName","pgGetGqlTypeByTypeIdAndModifier","pgSql","sql","GraphQLList","GraphQLNonNull","scope","isPgFieldConnection","isPgFieldSimpleCollection","pgFieldIntrospection","pgFieldIntrospectionTable","addArgDataGenerator","Self","field","proc","kind","tags","sortable","TableType","type","id","TableOrderByType","cursorPrefixFromOrderBy","orderBy","cursorPrefixes","item","push","literal","length","connectionOrderBy","rawOrderBy","Array","isArray","pgCursorPrefix","pgQuery","queryBuilder","unique","orders","col","ascending","specNullsFirst","expr","fragment","getTableAlias","identifier","nullsFirst","undefined","setOrderIsUnique"],"mappings":"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","file":"PgConnectionArgOrderBy.js","sourcesContent":["// @flow\nimport isString from \"lodash/isString\";\nimport type { Plugin } from \"graphile-build\";\n\nexport default (function PgConnectionArgOrderBy(builder, { orderByNullsLast }) {\n  builder.hook(\"init\", (_, build) => {\n    const {\n      newWithHooks,\n      pgIntrospectionResultsByKind: introspectionResultsByKind,\n      graphql: { GraphQLEnumType },\n      inflection,\n      pgOmit: omit,\n      sqlCommentByAddingTags,\n      describePgEntity,\n    } = build;\n    introspectionResultsByKind.class.forEach(table => {\n      // PERFORMANCE: These used to be .filter(...) calls\n      if (!table.isSelectable || omit(table, \"order\")) return;\n      if (!table.namespace) return;\n\n      const tableTypeName = inflection.tableType(table);\n      /* const TableOrderByType = */\n      newWithHooks(\n        GraphQLEnumType,\n        {\n          name: inflection.orderByType(tableTypeName),\n          description: `Methods to use when ordering \\`${tableTypeName}\\`.`,\n          values: {\n            NATURAL: {\n              value: {\n                alias: null,\n                specs: [],\n              },\n            },\n          },\n        },\n        {\n          __origin: `Adding connection \"orderBy\" argument for ${describePgEntity(\n            table\n          )}. You can rename the table's GraphQL type via:\\n\\n  ${sqlCommentByAddingTags(\n            table,\n            {\n              name: \"newNameHere\",\n            }\n          )}`,\n          pgIntrospection: table,\n          isPgRowSortEnum: true,\n        }\n      );\n    });\n    return _;\n  });\n\n  builder.hook(\n    \"GraphQLObjectType:fields:field:args\",\n    (args, build, context) => {\n      const {\n        extend,\n        getTypeByName,\n        pgGetGqlTypeByTypeIdAndModifier,\n        pgSql: sql,\n        graphql: { GraphQLList, GraphQLNonNull },\n        inflection,\n        pgOmit: omit,\n      } = build;\n      const {\n        scope: {\n          isPgFieldConnection,\n          isPgFieldSimpleCollection,\n          pgFieldIntrospection,\n          pgFieldIntrospectionTable,\n        },\n        addArgDataGenerator,\n        Self,\n        field,\n      } = context;\n\n      if (!isPgFieldConnection && !isPgFieldSimpleCollection) {\n        return args;\n      }\n\n      const proc =\n        pgFieldIntrospection.kind === \"procedure\" ? pgFieldIntrospection : null;\n      const table =\n        pgFieldIntrospection.kind === \"class\"\n          ? pgFieldIntrospection\n          : proc\n            ? pgFieldIntrospectionTable\n            : null;\n      if (\n        !table ||\n        !table.namespace ||\n        !table.isSelectable ||\n        omit(table, \"order\")\n      ) {\n        return args;\n      }\n      if (proc) {\n        if (!proc.tags.sortable) {\n          return args;\n        }\n      }\n      const TableType = pgGetGqlTypeByTypeIdAndModifier(table.type.id, null);\n      const tableTypeName = TableType.name;\n      const TableOrderByType = getTypeByName(\n        inflection.orderByType(tableTypeName)\n      );\n      const cursorPrefixFromOrderBy = orderBy => {\n        if (orderBy) {\n          let cursorPrefixes = [];\n          for (const item of orderBy) {\n            if (item.alias) {\n              cursorPrefixes.push(sql.literal(item.alias));\n            }\n          }\n          if (cursorPrefixes.length > 0) {\n            return cursorPrefixes;\n          }\n        }\n        return null;\n      };\n\n      addArgDataGenerator(function connectionOrderBy({ orderBy: rawOrderBy }) {\n        const orderBy = rawOrderBy\n          ? Array.isArray(rawOrderBy)\n            ? rawOrderBy\n            : [rawOrderBy]\n          : null;\n        return {\n          pgCursorPrefix: cursorPrefixFromOrderBy(orderBy),\n          pgQuery: queryBuilder => {\n            if (orderBy != null) {\n              orderBy.forEach(item => {\n                const { specs, unique } = item;\n                const orders =\n                  Array.isArray(specs[0]) || specs.length === 0\n                    ? specs\n                    : [specs];\n                orders.forEach(([col, ascending, specNullsFirst]) => {\n                  const expr = isString(col)\n                    ? sql.fragment`${queryBuilder.getTableAlias()}.${sql.identifier(\n                        col\n                      )}`\n                    : col;\n                  // If the enum specifies null ordering, use that\n                  // Otherwise, use the orderByNullsLast option if present\n                  const nullsFirst =\n                    specNullsFirst != null\n                      ? specNullsFirst\n                      : orderByNullsLast != null\n                        ? !orderByNullsLast\n                        : undefined;\n                  queryBuilder.orderBy(expr, ascending, nullsFirst);\n                });\n                if (unique) {\n                  queryBuilder.setOrderIsUnique();\n                }\n              });\n            }\n          },\n        };\n      });\n\n      return extend(\n        args,\n        {\n          orderBy: {\n            description: `The method to use when ordering \\`${tableTypeName}\\`.`,\n            type: new GraphQLList(new GraphQLNonNull(TableOrderByType)),\n          },\n        },\n        `Adding 'orderBy' argument to field '${field.name}' of '${Self.name}'`\n      );\n    }\n  );\n}: Plugin);\n"]}