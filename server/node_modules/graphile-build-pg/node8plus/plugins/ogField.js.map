{"version":3,"sources":["../../src/plugins/ogField.js"],"names":["pgField","build","fieldWithHooks","fieldName","fieldSpec","fieldScope","whereFrom","options","type","FieldType","pgSql","sql","pgQueryFromResolveData","queryFromResolveData","getSafeAliasFromAlias","getSafeAliasFromResolveInfo","nullableType","graphql","getNullableType","namedType","getNamedType","isListType","constructor","GraphQLList","fieldContext","getDataFromParsedResolveInfoFragment","addDataGenerator","withFieldContext","parsedResolveInfoFragment","safeAlias","alias","resolveData","hoistCursor","usesCursor","length","pgQuery","queryBuilder","select","tableAlias","getTableAlias","identifier","Symbol","query","onlyJsonField","asJson","innerQueryBuilder","parentQueryBuilder","withQueryBuilder","fragment","resolve","data","_args","_context","resolveInfo","map","d"],"mappings":";;;;;kBAAwBA,O;AAAT,SAASA,OAAT,CACbC,KADa,EAEbC,cAFa,EAGbC,SAHa,EAIbC,SAJa,EAKbC,aAAa,EALA,EAMbC,YAAY,KANC,EAObC,UAAU,EAPG,EAQb;AACA,QAAM,EAAEC,MAAMC,SAAR,KAAsBL,SAA5B;AACA,QAAM;AACJM,WAAOC,GADH;AAEJC,4BAAwBC,oBAFpB;AAGJC,yBAHI;AAIJC;AAJI,MAKFd,KALJ;AAMA,QAAMe,eAAef,MAAMgB,OAAN,CAAcC,eAAd,CAA8BT,SAA9B,CAArB;AACA,QAAMU,YAAYlB,MAAMgB,OAAN,CAAcG,YAAd,CAA2BX,SAA3B,CAAlB;AACA,QAAMY,aACJL,iBAAiBG,SAAjB,IACAH,aAAaM,WAAb,KAA6BrB,MAAMgB,OAAN,CAAcM,WAF7C;AAGA,SAAOrB,eACLC,SADK,EAELqB,gBAAgB;AACd,UAAM;AACJC,0CADI;AAEJC;AAFI,QAGFF,YAHJ;AAIA,QAAI,OAAOjB,QAAQoB,gBAAf,KAAoC,UAAxC,EAAoD;AAClDpB,cAAQoB,gBAAR,CAAyBH,YAAzB;AACD;AACDE,qBAAiBE,6BAA6B;AAC5C,YAAMC,YAAYf,sBAChBc,0BAA0BE,KADV,CAAlB;AAGA,YAAMC,cAAcN,qCAClBG,yBADkB,EAElBnB,SAFkB,CAApB;AAIA,aAAO;AACL,YAAIF,QAAQyB,WAAR,IACJD,YAAYE,UADR,IAEJF,YAAYE,UAAZ,CAAuBC,MAFnB,GAGA,EAAED,YAAY,CAAC,IAAD,CAAd,EAHA,GAIA,IAJJ,CADK;AAMLE,iBAASC,gBAAgB;AACvBA,uBAAaC,MAAb,CAAoB,MAAM;AACxB,kBAAMC,aACJhC,cAAc,KAAd,GACI8B,aAAaG,aAAb,EADJ,GAEI5B,IAAI6B,UAAJ,CAAeC,QAAf,CAHN;AAIA,kBAAMC,QAAQ7B,qBACZP,YAAYA,UAAU8B,YAAV,CAAZ,GAAsCzB,IAAI6B,UAAJ,CAAeC,QAAf,CAD1B,EAEZH,UAFY,EAGZP,WAHY,EAIZzB,cAAc,KAAd,GACI,EAAEqC,eAAe,IAAjB,EADJ,GAEI,EAAEC,QAAQ,IAAV,EANQ,EAOZC,qBAAqB;AACnBA,gCAAkBC,kBAAlB,GAAuCV,YAAvC;AACA,kBAAI,OAAO7B,QAAQwC,gBAAf,KAAoC,UAAxC,EAAoD;AAClDxC,wBAAQwC,gBAAR,CAAyBF,iBAAzB,EAA4C;AAC1CjB;AAD0C,iBAA5C;AAGD;AACF,aAdW,CAAd;AAgBA,mBAAOjB,IAAIqC,QAAS,IAAGN,KAAM,GAA7B;AACD,WAtBD,EAsBGb,SAtBH;AAuBD;AA9BI,OAAP;AAgCD,KAxCD;;AA0CA,WAAO;AACLoB,cAAQC,IAAR,EAAcC,KAAd,EAAqBC,QAArB,EAA+BC,WAA/B,EAA4C;AAC1C,cAAMxB,YAAYd,4BAA4BsC,WAA5B,CAAlB;AACA,YAAIH,KAAKA,IAAL,IAAa,IAAjB,EAAuB,OAAO,IAAP;AACvB,YAAI7B,UAAJ,EAAgB;AACd,iBAAO6B,KAAKA,IAAL,CAAUI,GAAV,CAAcC,KAAMA,KAAK,IAAL,GAAYA,EAAE1B,SAAF,CAAZ,GAA2B,IAA/C,CAAP;AACD,SAFD,MAEO;AACL,iBAAOqB,KAAKA,IAAL,CAAUrB,SAAV,CAAP;AACD;AACF,OATI;AAUL,SAAGzB;AAVE,KAAP;AAYD,GAhEI,EAiELC,UAjEK,CAAP;AAmED","file":"ogField.js","sourcesContent":["export default function pgField(\n  build,\n  fieldWithHooks,\n  fieldName,\n  fieldSpec,\n  fieldScope = {},\n  whereFrom = false,\n  options = {}\n) {\n  const { type: FieldType } = fieldSpec;\n  const {\n    pgSql: sql,\n    pgQueryFromResolveData: queryFromResolveData,\n    getSafeAliasFromAlias,\n    getSafeAliasFromResolveInfo,\n  } = build;\n  const nullableType = build.graphql.getNullableType(FieldType);\n  const namedType = build.graphql.getNamedType(FieldType);\n  const isListType =\n    nullableType !== namedType &&\n    nullableType.constructor === build.graphql.GraphQLList;\n  return fieldWithHooks(\n    fieldName,\n    fieldContext => {\n      const {\n        getDataFromParsedResolveInfoFragment,\n        addDataGenerator,\n      } = fieldContext;\n      if (typeof options.withFieldContext === \"function\") {\n        options.withFieldContext(fieldContext);\n      }\n      addDataGenerator(parsedResolveInfoFragment => {\n        const safeAlias = getSafeAliasFromAlias(\n          parsedResolveInfoFragment.alias\n        );\n        const resolveData = getDataFromParsedResolveInfoFragment(\n          parsedResolveInfoFragment,\n          FieldType\n        );\n        return {\n          ...(options.hoistCursor &&\n          resolveData.usesCursor &&\n          resolveData.usesCursor.length\n            ? { usesCursor: [true] }\n            : null),\n          pgQuery: queryBuilder => {\n            queryBuilder.select(() => {\n              const tableAlias =\n                whereFrom === false\n                  ? queryBuilder.getTableAlias()\n                  : sql.identifier(Symbol());\n              const query = queryFromResolveData(\n                whereFrom ? whereFrom(queryBuilder) : sql.identifier(Symbol()),\n                tableAlias,\n                resolveData,\n                whereFrom === false\n                  ? { onlyJsonField: true }\n                  : { asJson: true },\n                innerQueryBuilder => {\n                  innerQueryBuilder.parentQueryBuilder = queryBuilder;\n                  if (typeof options.withQueryBuilder === \"function\") {\n                    options.withQueryBuilder(innerQueryBuilder, {\n                      parsedResolveInfoFragment,\n                    });\n                  }\n                }\n              );\n              return sql.fragment`(${query})`;\n            }, safeAlias);\n          },\n        };\n      });\n\n      return {\n        resolve(data, _args, _context, resolveInfo) {\n          const safeAlias = getSafeAliasFromResolveInfo(resolveInfo);\n          if (data.data == null) return null;\n          if (isListType) {\n            return data.data.map(d => (d != null ? d[safeAlias] : null));\n          } else {\n            return data.data[safeAlias];\n          }\n        },\n        ...fieldSpec,\n      };\n    },\n    fieldScope\n  );\n}\n"]}